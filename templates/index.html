<!-- <!DOCTYPE html>
<html>

<head>
    <title>OCR Processing</title>
    <style>
        body {
            display: flex;
            margin: 0;
            height: 100vh;
        }

        #left-side {
            flex: 1;
            padding: 20px;
            background-color: #f0f0f0;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        #right-side {
            flex: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            box-shadow: -4px 0 6px rgba(0, 0, 0, 0.1);
        }

        #image-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: inline-block;
            overflow: hidden;
        }

        .selectable-box {
            position: absolute;
            border: 2px dashed red;
            background-color: rgba(255, 0, 0, 0.2);
            cursor: crosshair;
        }

        #cancel-button {
            display: none;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        img {
            user-drag: none;
            /* For most browsers */
            -webkit-user-drag: none;
            /* For WebKit-based browsers */
        }
    </style>
    <script>
        let startX, startY, endX, endY;
        let selectionBox;
        let isSelecting = false;
        let selectedField = '';

        const fieldMapping = {
            "GOVT RANK": "govt_rank",
            "APPLICATION NUMBER": "application_number",
            "NAME OF THE CANDIDATE": "name",
            "DATE OF BIRTH": "dob",
            "AGGREGATE MARK": "aggregate_mark",
            "COMMUNITY": "community",
            "GOVT COMMUNITY RANK": "govt_community_rank"
        };

        function startSelection(event) {
            if (event.ctrlKey) {
                if (isSelecting) return;

                const imgElement = document.getElementById('processed-image');
                if (!imgElement) return;

                const rect = imgElement.getBoundingClientRect();
                startX = event.clientX - rect.left;
                startY = event.clientY - rect.top;

                selectionBox = document.createElement('div');
                selectionBox.className = 'selectable-box';
                selectionBox.style.left = `${startX}px`;
                selectionBox.style.top = `${startY}px`;
                document.getElementById('image-container').appendChild(selectionBox);

                isSelecting = true;
                document.getElementById('cancel-button').style.display = 'inline';

                document.addEventListener('mousemove', updateSelection);
                document.addEventListener('mouseup', endSelection);
            }
        }

        function updateSelection(event) {
            if (!isSelecting) return;

            const imgElement = document.getElementById('processed-image');
            const rect = imgElement.getBoundingClientRect();
            endX = event.clientX - rect.left;
            endY = event.clientY - rect.top;

            selectionBox.style.width = `${Math.abs(endX - startX)}px`;
            selectionBox.style.height = `${Math.abs(endY - startY)}px`;
            selectionBox.style.left = `${Math.min(startX, endX)}px`;
            selectionBox.style.top = `${Math.min(startY, endY)}px`;
        }

        function endSelection(event) {
            if (!isSelecting) return;

            document.removeEventListener('mousemove', updateSelection);
            document.removeEventListener('mouseup', endSelection);

            const imgElement = document.getElementById('processed-image');
            const rect = imgElement.getBoundingClientRect();
            endX = event.clientX - rect.left;
            endY = event.clientY - rect.top;

            const x1 = Math.min(startX, endX);
            const y1 = Math.min(startY, endY);
            const x2 = Math.max(startX, endX);
            const y2 = Math.max(startY, endY);

            fetchText(x1, y1, x2, y2);

            selectionBox.remove();
            isSelecting = false;
            document.getElementById('cancel-button').style.display = 'none';
        }

        function cancelSelection() {
            if (isSelecting) {
                selectionBox.remove();
                document.removeEventListener('mousemove', updateSelection);
                document.removeEventListener('mouseup', endSelection);
                isSelecting = false;
                document.getElementById('cancel-button').style.display = 'none';
            }
        }

        function fetchText(x1, y1, x2, y2) {
            const x1Int = Math.round(x1);
            const y1Int = Math.round(y1);
            const x2Int = Math.round(x2);
            const y2Int = Math.round(y2);

            fetch(`/get_text/?x1=${x1Int}&y1=${y1Int}&x2=${x2Int}&y2=${y2Int}`)
                .then(response => response.json())
                .then(data => {
                    if (data.text) {
                        console.log('Extracted Text:', data.text);
                        autoFillField(data.text);
                    } else {
                        alert('Error extracting text');
                    }
                })
                .catch(error => alert('An error occurred: ' + error));
        }

        function autoFillField(extractedText) {
            if (!selectedField) {
                console.log("No field selected.");
                return;
            }

            const fieldId = fieldMapping[selectedField];
            if (fieldId) {
                const inputElement = document.getElementById(fieldId);
                if (inputElement) {
                    let value = extractedText.trim().toUpperCase().replace(/\|/g, ''); // Remove pipe characters

                    // Convert date format if needed
                    if (fieldId === 'dob') {
                        value = convertDateFormat(value);
                    }

                    inputElement.value = value;
                } else {
                    console.log("No matching input field found for ID:", fieldId);
                }
            } else {
                console.log("Selected field not found in mapping:", selectedField);
            }
        }

        function convertDateFormat(dateStr) {
            const parts = dateStr.split('-');
            if (parts.length === 3) {
                const day = parts[0];
                const month = parts[1];
                const year = parts[2];
                return `${year}-${month}-${day}`;
            }
            return dateStr; // Return original if format is unexpected
        }

        function bindStartSelection() {
            const imgElement = document.getElementById('processed-image');
            if (imgElement) {
                imgElement.addEventListener('mousedown', startSelection);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            bindStartSelection();

            // Set up the dropdown to select a field
            const fieldSelect = document.getElementById('field-select');
            if (fieldSelect) {
                fieldSelect.addEventListener('change', (event) => {
                    selectedField = event.target.value;
                });
            }
        });
    </script>
</head>

<body>
    <div id="left-side">
        <form id="dataForm" action="/submit_data/" method="post">
            <div class="form-group">
                <label for="field-select">Select Field</label>
                <select id="field-select" name="field-select">
                    <option value="">Select Field</option>
                    <option value="GOVT RANK">GOVT RANK</option>
                    <option value="APPLICATION NUMBER">APPLICATION NUMBER</option>
                    <option value="NAME OF THE CANDIDATE">NAME OF THE CANDIDATE</option>
                    <option value="DATE OF BIRTH">DATE OF BIRTH</option>
                    <option value="AGGREGATE MARK">AGGREGATE MARK</option>
                    <option value="COMMUNITY">COMMUNITY</option>
                    <option value="GOVT COMMUNITY RANK">GOVT COMMUNITY RANK</option>
                </select>
            </div>
            <div class="form-group">
                <label for="govt-rank">GOVT RANK</label>
                <input type="text" id="govt_rank" name="govt_rank" required>
            </div>
            <div class="form-group">
                <label for="application-number">APPLICATION NUMBER</label>
                <input type="text" id="application_number" name="application_number" required>
            </div>
            <div class="form-group">
                <label for="name">NAME OF THE CANDIDATE</label>
                <input type="text" id="name" name="name" required>
            </div>
            <div class="form-group">
                <label for="dob">DATE OF BIRTH</label>
                <input type="date" id="dob" name="dob" required>
            </div>
            <div class="form-group">
                <label for="aggregate-mark">AGGREGATE MARK</label>
                <input type="text" id="aggregate_mark" name="aggregate_mark" required>
            </div>
            <div class="form-group">
                <label for="community">COMMUNITY</label>
                <input type="text" id="community" name="community" required>
            </div>
            <div class="form-group">
                <label for="govt-community-rank">GOVT COMMUNITY RANK</label>
                <input type="text" id="govt_community_rank" name="govt_community_rank" required>
            </div>
            <button type="submit">Submit</button>
        </form>

    </div>
    <div id="right-side">
        <h2>Upload Image for OCR Processing</h2>
        <form action="/upload/" method="post" enctype="multipart/form-data">
            <input type="file" name="file" accept="image/*" required>
            <button type="submit">Upload</button>
        </form>
        {% if image_filename %}
        <div id="image-container">
            <img id="processed-image" src="/static/{{ image_filename }}" alt="Processed Image">
        </div>
        <div id="cancel-button" onclick="cancelSelection()"></div>
        {% endif %}
    </div>
</body>
</html> -->

<!DOCTYPE html>
<html>

<head>
    <title>OCR Processing</title>
    <style>
        body {
            display: flex;
            margin: 0;
            height: 100vh;
        }

        #left-side {
            flex: 1;
            padding: 20px;
            background-color: #f0f0f0;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        #right-side {
            flex: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            box-shadow: -4px 0 6px rgba(0, 0, 0, 0.1);
        }

        #image-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: inline-block;
            overflow: hidden;
        }

        .selectable-box {
            position: absolute;
            border: 2px dashed red;
            background-color: rgba(255, 0, 0, 0.2);
            cursor: crosshair;
        }

        #cancel-button {
            display: none;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        img {
            user-drag: none;

            -webkit-user-drag: none;
            /* For WebKit-based browsers */
        }
    </style>
    <script>
        let startX, startY, endX, endY;
        let selectionBox;
        let isSelecting = false;
        let selectedField = '';

        const fieldMapping = {
            "GOVT RANK": "govt_rank",
            "APPLICATION NUMBER": "application_number",
            "NAME OF THE CANDIDATE": "name",
            "DATE OF BIRTH": "dob",
            "AGGREGATE MARK": "aggregate_mark",
            "COMMUNITY": "community",
            "GOVT COMMUNITY RANK": "govt_community_rank"
        };

        function startSelection(event) {
            if (event.ctrlKey) {
                if (isSelecting) return;

                const imgElement = document.getElementById('processed-image');
                if (!imgElement) return;

                const rect = imgElement.getBoundingClientRect();
                startX = event.clientX - rect.left;
                startY = event.clientY - rect.top;

                selectionBox = document.createElement('div');
                selectionBox.className = 'selectable-box';
                selectionBox.style.left = `${startX}px`;
                selectionBox.style.top = `${startY}px`;
                document.getElementById('image-container').appendChild(selectionBox);

                isSelecting = true;
                document.getElementById('cancel-button').style.display = 'inline';

                document.addEventListener('mousemove', updateSelection);
                document.addEventListener('mouseup', endSelection);
            }
        }

        function updateSelection(event) {
            if (!isSelecting) return;

            const imgElement = document.getElementById('processed-image');
            const rect = imgElement.getBoundingClientRect();
            endX = event.clientX - rect.left;
            endY = event.clientY - rect.top;

            selectionBox.style.width = `${Math.abs(endX - startX)}px`;
            selectionBox.style.height = `${Math.abs(endY - startY)}px`;
            selectionBox.style.left = `${Math.min(startX, endX)}px`;
            selectionBox.style.top = `${Math.min(startY, endY)}px`;
        }

        function endSelection(event) {
            if (!isSelecting) return;

            document.removeEventListener('mousemove', updateSelection);
            document.removeEventListener('mouseup', endSelection);

            const imgElement = document.getElementById('processed-image');
            const rect = imgElement.getBoundingClientRect();
            endX = event.clientX - rect.left;
            endY = event.clientY - rect.top;

            const x1 = Math.min(startX, endX);
            const y1 = Math.min(startY, endY);
            const x2 = Math.max(startX, endX);
            const y2 = Math.max(startY, endY);

            fetchText(x1, y1, x2, y2);

            selectionBox.remove();
            isSelecting = false;
            document.getElementById('cancel-button').style.display = 'none';
        }

        function cancelSelection() {
            if (isSelecting) {
                selectionBox.remove();
                document.removeEventListener('mousemove', updateSelection);
                document.removeEventListener('mouseup', endSelection);
                isSelecting = false;
                document.getElementById('cancel-button').style.display = 'none';
            }
        }

        function fetchText(x1, y1, x2, y2) {
            const x1Int = Math.round(x1);
            const y1Int = Math.round(y1);
            const x2Int = Math.round(x2);
            const y2Int = Math.round(y2);

            fetch(`/get_text/?x1=${x1Int}&y1=${y1Int}&x2=${x2Int}&y2=${y2Int}`)
                .then(response => response.json())
                .then(data => {
                    if (data.text) {
                        autoFillField(data.text);
                    } else {
                        alert('Error extracting text');
                    }
                })
                .catch(error => alert('An error occurred: ' + error));
        }

        function autoFillField(extractedText) {
            if (!selectedField) {
                alert("No field selected.");
                return;
            }

            const fieldId = fieldMapping[selectedField];
            if (fieldId) {
                const inputElement = document.getElementById(fieldId);
                if (inputElement) {
                    let value = extractedText.trim().toUpperCase().replace(/\|/g, '');

                    if (fieldId === 'dob') {
                        value = convertDateFormat(value);
                    }

                    inputElement.value = value;
                }
            }
        }
        function drawBoundingBoxes(boxes) {
            const imgElement = document.getElementById('processed-image');
            const container = document.getElementById('image-container');

            // Remove any existing bounding boxes
            const existingBoxes = document.querySelectorAll('.selectable-box');
            existingBoxes.forEach(box => box.remove());

            // Draw each bounding box
            boxes.forEach(box => {
                const { x1, y1, x2, y2 } = box;
                const boxElement = document.createElement('div');
                boxElement.className = 'selectable-box';
                boxElement.style.left = `${x1}px`;
                boxElement.style.top = `${y1}px`;
                boxElement.style.width = `${x2 - x1}px`;
                boxElement.style.height = `${y2 - y1}px`;
                container.appendChild(boxElement);

                boxElement.addEventListener('click', () => {
                    // Example bounding box click handling
                    fetchText(x1, y1, x2, y2);
                });
            });
        }

        function convertDateFormat(dateStr) {
            const parts = dateStr.split('-');
            if (parts.length === 3) {
                const day = parts[0];
                const month = parts[1];
                const year = parts[2];
                return `${year}-${month}-${day}`;
            }
            return dateStr;
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('processed-image').addEventListener('mousedown', startSelection);

            document.getElementById('field-select').addEventListener('change', (event) => {
                selectedField = event.target.value;
            });
        });
    </script>
</head>

<body>
    <div id="left-side">
        <form id="dataForm" action="/submit_data/" method="post">
            <div class="form-group">
                <label for="field-select">Select Field</label>
                <select id="field-select" name="field-select">
                    <option value="">Select Field</option>
                    <option value="GOVT RANK">GOVT RANK</option>
                    <option value="APPLICATION NUMBER">APPLICATION NUMBER</option>
                    <option value="NAME OF THE CANDIDATE">NAME OF THE CANDIDATE</option>
                    <option value="DATE OF BIRTH">DATE OF BIRTH</option>
                    <option value="AGGREGATE MARK">AGGREGATE MARK</option>
                    <option value="COMMUNITY">COMMUNITY</option>
                    <option value="GOVT COMMUNITY RANK">GOVT COMMUNITY RANK</option>
                </select>
            </div>
            <div class="form-group">
                <label for="govt-rank">GOVT RANK</label>
                <input type="text" id="govt_rank" name="govt_rank" required>
            </div>
            <div class="form-group">
                <label for="application-number">APPLICATION NUMBER</label>
                <input type="text" id="application_number" name="application_number" required>
            </div>
            <div class="form-group">
                <label for="name">NAME OF THE CANDIDATE</label>
                <input type="text" id="name" name="name" required>
            </div>
            <div class="form-group">
                <label for="dob">DATE OF BIRTH</label>
                <input type="date" id="dob" name="dob" required>
            </div>
            <div class="form-group">
                <label for="aggregate-mark">AGGREGATE MARK</label>
                <input type="text" id="aggregate_mark" name="aggregate_mark" required>
            </div>
            <div class="form-group">
                <label for="community">COMMUNITY</label>
                <input type="text" id="community" name="community" required>
            </div>
            <div class="form-group">
                <label for="govt-community-rank">GOVT COMMUNITY RANK</label>
                <input type="text" id="govt_community_rank" name="govt_community_rank" required>
            </div>
            <button type="submit">Submit</button>
        </form>

    </div>
    <div id="right-side">
        <h2>Upload Image for OCR Processing</h2>
        <form action="/upload/" method="post" enctype="multipart/form-data">
            <input type="file" name="file" accept="image/*" required>
            <button type="submit">Upload</button>
        </form>
        {% if image_filename %}
        <div id="image-container">
            <img id="processed-image" src="/static/{{ image_filename }}" alt="Processed Image">
        </div>
        <div id="cancel-button" onclick="cancelSelection()"></div>
        {% endif %}
    </div>
</body>

</html>
